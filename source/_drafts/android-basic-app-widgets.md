---
title: Androidçš„å°éƒ¨ä»¶
tags:
- Android
---------


####  ä¸€ã€æ¦‚è§ˆï¼š
1.1 å°éƒ¨ä»¶çš„åˆ†ç±»
+ ä¿¡æ¯å±•ç¤ºå°éƒ¨ä»¶ï¼šå¤©æ°”å°éƒ¨ä»¶ä¸»è¦å±•ç¤ºå¤©æ°”ä¿¡æ¯
+ é›†åˆå°éƒ¨ä»¶ï¼šå¤šä¸ªç›¸åŒç±»å‹å…ƒç´ çš„é›†åˆï¼Œç›¸å†Œé¢„è§ˆå°éƒ¨ä»¶ã€æ–‡ç« é¢„è§ˆå°éƒ¨ä»¶ï¼Œå¯å‚ç›´æ»šåŠ¨ã€‚
+ æ§åˆ¶ç±»å°éƒ¨ä»¶ï¼šå¸¸ç”¨åŠŸèƒ½çš„å¼€å…³ç­‰
+ æ··åˆç±»å‹å°éƒ¨ä»¶ï¼šéŸ³ä¹æ’­æ”¾å°éƒ¨ä»¶æ—¢æœ‰æ§åˆ¶æ“ä½œä¹Ÿèƒ½å±•ç¤ºä¿¡æ¯


1.2 å’Œè°·æ­ŒåŠ©æ‰‹æ•´åˆ
    é€šè¿‡ç›¸å…³é›†æˆï¼Œä¸Šè¿°å°éƒ¨ä»¶å¯ä»¥é€šè¿‡è¯­éŸ³æŒ‡ä»¤æ·»åŠ ã€‚

1.3 å°éƒ¨ä»¶çš„å±€é™æ€§
+ æ‰‹åŠ¿
    ç”±äºå°éƒ¨ä»¶åœ¨ä¸»å±å¹•å±•ç¤ºï¼Œéœ€è¦å’Œå¯¼èˆªå…±å­˜ï¼Œæ‰€ä»¥å·¦å³æ»‘åŠ¨åªèƒ½äº¤ç»™å¯¼èˆªæ¥å¤„ç†ã€‚å°éƒ¨ä»¶åªèƒ½å¤„ç†è§¦æ‘¸å’Œå‚ç›´æ»‘åŠ¨ã€‚
+ å…ƒç´ 
    ç”±äºä¸Šè¿°æ‰‹åŠ¿äº¤äº’çš„çº¦æŸï¼Œä¸€äº›UIå…ƒç´ å°±ä¸èƒ½ä½¿ç”¨äº†ã€‚

1.4 è®¾è®¡æŒ‡å¼•
+ å°éƒ¨ä»¶å†…å®¹
    å°éƒ¨ä»¶æ˜¯å¸å¼•ç”¨æˆ·è¿›å…¥appçš„ç»ä½³æœºåˆ¶ã€‚
+ å°éƒ¨ä»¶å¯¼èˆª
    å°†ç”¨æˆ·å¯¼èˆªåˆ°å¸¸ç”¨åŠŸèƒ½ï¼Œå¿«é€Ÿå®Œæˆç”¨æˆ·çš„æ„å›¾ã€‚
+ å°éƒ¨ä»¶çš„å°ºå¯¸
    é•¿æŒ‰å¹¶æ”¾æ‰‹è¿›å…¥å¤§å°è°ƒèŠ‚æ¨¡å¼ã€‚é€šè¿‡å°ºå¯¸å˜åŒ–ï¼Œæ§åˆ¶ä¿¡æ¯çš„å±•ç¤ºé‡ã€‚
+ å¸ƒå±€æ³¨æ„äº‹é¡¹
    æ ¹æ®è®¾å¤‡ç½‘æ ¼çš„åˆ†è¾¨ç‡æ¥æ‘†æ”¾å¸ƒå±€ã€‚è®°ä½ä»¥ä¸‹å‡ ç‚¹ï¼š

- Planning your widget resizing strategy across "size buckets" rather than variable grid dimensions gives you the most reliable results
- The number, size, and spacing of cells can vary widely from device to device. Hence, it is very important that your widget is flexible and can accommodate more or less space than anticipated
- In fact, as the user resizes a widget, the system responds with a dp size range in which your widget can redraw itself.
- Android-12åï¼Œä½ èƒ½æ›´ç²¾ç¡®çš„æŒ‡å®šå°ºå¯¸å’Œçµæ´»å¸ƒå±€ï¼š
  - ç•¥
  - ç•¥
  - ç•¥
  - ç•¥


1.5 å°éƒ¨ä»¶è®¾è®¡æ¸…å•
+ ç„ä¸€çœ¼çš„ä¿¡æ¯æ”¾åœ¨å°éƒ¨ä»¶ä¸Šï¼Œè¯¦ç»†ä¿¡æ¯æ”¾è¿›app
+ æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚å°éƒ¨ä»¶ç±»å‹
+ å†…å®¹å’Œå°ºå¯¸çš„é€‚é…
+ ç¡®ä¿å¸ƒå±€èƒ½å¤Ÿä¼¸å±•æ¥ä¿è¯è®¾å¤‡æ— å…³
+ æ€è€ƒæ˜¯å¦éœ€è¦é¢å¤–çš„é…ç½®


####  äºŒã€åˆ›å»ºç®€å•çš„å°éƒ¨ä»¶

##### 2.1 æ¶‰åŠçš„ç±»
+ `AppWidgetProviderInfo`
    æè¿°å°éƒ¨ä»¶å…ƒä¿¡æ¯ï¼Œå¸ƒå±€ã€æ›´æ–°é¢‘ç‡ç­‰
+ `AppWidgetProvider`
    å®šä¹‰äº¤äº’çš„ç¼–ç¨‹æ¥å£ã€‚


<center>
    <img src="../images/android-appwidget-overview.jpeg" width="50%"/>
</center>

é™¤äº†åŸºæœ¬çš„å…ƒå™¨ä»¶ï¼Œå¦‚æœä½ çš„å°éƒ¨ä»¶éœ€è¦ç”¨æˆ·é…ç½®ä¿¡æ¯ï¼Œä½ éœ€è¦æä¾›é…ç½®ä¿®æ”¹ç•Œé¢è®©ç”¨æˆ·ä¿®æ”¹é…ç½®ï¼Œå¦‚é’Ÿè¡¨å°éƒ¨ä»¶çš„æ—¶åŒºä¿®æ”¹ã€‚
+ Android-12èµ·ï¼Œæä¾›é»˜è®¤é…ç½®ï¼Œä¹‹åç”¨æˆ·å†ä¿®æ”¹ã€‚
+ Android-11åŠä»¥å‰ï¼Œæ¯æ¬¡æ·»åŠ å°éƒ¨ä»¶éƒ½å¯åŠ¨é…ç½®é¡µã€‚


#####  2.2 å£°æ˜`AppWidgetProviderInfo`
åœ¨res/xml/å£°æ˜ï¼š
```xml
<appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android"
    android:minWidth="40dp"
    android:minHeight="40dp"
    android:targetCellWidth="1"
    android:targetCellHeight="1"
    android:maxResizeWidth="250dp"
    android:maxResizeHeight="120dp"
    android:updatePeriodMillis="86400000"
    android:description="@string/example_appwidget_description"
    android:previewLayout="@layout/example_appwidget_preview"
    android:initialLayout="@layout/example_loading_appwidget"
    android:configure="com.example.android.ExampleAppWidgetConfigurationActivity"
    android:resizeMode="horizontal|vertical"
    android:widgetCategory="home_screen"
    android:widgetFeatures="reconfigurable|configuration_optional">
</appwidget-provider>

```

2.2.1 å°ºå¯¸å±æ€§:
+ `targetCellWidth` & `targetCellHeight` (Android-12æ–°å¢)
+ `maxResizeWidth` & `maxResizeHeight` (Android-12æ–°å¢)
+ `minWidth` & `minHeight`
+ `minResizeWidth` & `minResizeHeight`
+ `resizeMode`

2.2.2 å…¶ä»–å±æ€§ï¼š
+ updatePeriodMillis
+ initialLayout
+ configure
+ description
+ previewLayout(Android-12) & previewImage(Android11-â†“)
+ autoAdvanceViewId
+ widgetCategory
+ widgetFeatures


##### 2.3 ä½¿ç”¨`AppWidgetProvider`ç±»å¤„ç†å¹¿æ’­

2.3.1 åœ¨`AndroidManifest`å£°æ˜

```xml
<receiver android:name="ExampleAppWidgetProvider"
                 android:exported="false">
    <intent-filter>
        <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
    </intent-filter>
    <meta-data android:name="android.appwidget.provider"
               android:resource="@xml/example_appwidget_info" />
</receiver>
```

2.3.2 å®ç°`AppWidgetProvider`ç±»
+ onUpdate()
+ onAppWidgetOptionsChanged()
+ onDeleted(Context, int[])
+ onEnabled(Context)
+ onDisabled(Context)
+ onReceive(Context, Intent)

å…¶ä¸­`onUpdate()`å›è°ƒå°¤ä¸ºé‡è¦ã€‚


2.3.3 æ¥æ”¶å°éƒ¨ä»¶å¹¿æ’­æ„å›¾
+ ACTION_APPWIDGET_UPDATE
+ ACTION_APPWIDGET_DELETED
+ ACTION_APPWIDGET_ENABLED
+ ACTION_APPWIDGET_DISABLED
+ ACTION_APPWIDGET_OPTIONS_CHANGED



##### 2.4 åˆ›å»ºå¸ƒå±€
å¸ƒå±€åŸºäºRemoteViewså®ç°ï¼Œä¸èƒ½ä½¿ç”¨è‡ªå®šä¹‰viewã€‚ä¹Ÿä¸èƒ½ä½¿ç”¨RemoteViewsæ”¯æŒçš„ç±»çš„å­ç±»ã€‚ä½†å®ƒæ”¯æŒViewStubã€‚

2.4.1 å¯¹çŠ¶æ€è¡Œä¸ºçš„æ”¯æŒ
Android-12æ”¯æŒä»¥ä¸‹åŒ…å«çŠ¶æ€çš„Viewï¼Œä½†æ˜¯éœ€è¦ä¿å­˜çŠ¶æ€å¹¶æ³¨å†ŒçŠ¶æ€å˜æ›´äº‹ä»¶ã€‚
+ CheckBox
+ Switch
+ RadioButton

```kotlin
// Check the view.
remoteView.setCompoundButtonChecked(R.id.my_checkbox, true)

// Check a radio group.
remoteView.setRadioGroupChecked(R.id.my_radio_group, R.id.radio_button_2)

// Listen for check changes. The intent will have an extra with the key
// EXTRA_CHECKED that specifies the current checked state of the view.
remoteView.setOnCheckedChangeResponse(
        R.id.my_checkbox,
        RemoteViews.RemoteResponse.fromPendingIntent(onCheckedChangePendingIntent)
)
```

##### 2.5 å®ç°åœ†è§’
Android-12æ–°å¢çš„å‚æ•°ï¼š
+ system_app_widget_background_radius ä¸èƒ½å¤§äº28dp
+ system_app_widget_inner_radius

<center>
    <img src="../images/android-appwidget-corner.png" width="50%"/>
</center>


#### ä¸‰ã€Android-12çš„å˜æ›´

##### 3.1 æ·»åŠ è®¾å¤‡ä¸»é¢˜
    3.1.1 ä½¿ç”¨åŠ¨æ€é¢œè‰²å‘åå…¼å®¹

##### 3.2 å£°éŸ³æ”¯æŒ

##### 3.3 ä¼˜åŒ–é€‰æ‹©å°éƒ¨ä»¶æ—¶çš„ä½“éªŒ
    Android-12å¢åŠ åŠ¨æ€é¢„è§ˆå’Œå°éƒ¨ä»¶æè¿°ã€‚


##### 3.4 æ·»åŠ å°éƒ¨ä»¶æè¿°
```xml
<appwidget-provider
    android:description="@string/my_widget_description">
</appwidget-provider>
```
##### 3.5 å¹³æ»‘è½¬åœºæ•ˆæœ
Android-12èµ·å½“ç”¨æˆ·ä»å°éƒ¨ä»¶æ‹‰èµ·åº”ç”¨æ—¶ï¼Œä½¿ç”¨`@android:id/background` or `android.R.id.background`ä¼˜åŒ–æ‹‰èµ·æ•ˆæœï¼š
```xml
// Top level layout of the widget.
<LinearLayout
    android:id="@android:id/background">
</LinearLayout>
```

##### 3.6 è¿è¡Œæ—¶ä¿®æ”¹`RemoteViews`
Android-12æ–°å¢ä¸€äº›æ–¹æ³•
```xml
// Set the colors of a progress bar at runtime.
remoteView.setColorStateList(R.id.progress, "setProgressTintList", createProgressColorStateList())

// Specify exact sizes for margins.
remoteView.setViewLayoutMargin(R.id.text, RemoteViews.MARGIN_END, 8f, TypedValue.COMPLEX_UNIT_DP)
```


#### å››ã€é«˜çº§å°éƒ¨ä»¶

4.1 å°éƒ¨ä»¶çš„æ›´æ–°
4.1.1 æ›´æ–°ç±»å‹
+ å…¨é‡æ›´æ–°ï¼š`AppWidgetManager.updateAppWidget(int, android.widget.RemoteViews)` ï¼Œæ–°RemoteViewå…¨é‡æ›¿æ¢æ—§RemoteView
+ éƒ¨åˆ†æ›´æ–°ï¼š`AppWidgetManager.partiallyUpdateAppWidget`ï¼Œæ–°RemoteViewåˆå¹¶å…¥æ—§RemoteView
+ æ•°æ®æ›´æ–°ï¼š`AppWidgetManager.notifyAppWidgetViewDataChanged`ï¼Œåˆ·æ–°ä¸€ç»„Viewçš„æ•°æ®

4.1.2 æ›´æ–°é¢‘ç‡

+ å‘¨æœŸæ›´æ–°
`updatePeriodMillis`å‚æ•°æ§åˆ¶æ›´æ–°é¢‘ç‡ä½†ä¸èƒ½å°äº30åˆ†é’Ÿå½“è®¾ç½®ä¸º0æ—¶ï¼Œå±è”½å‘¨æœŸæ›´æ–°ã€‚æ¯æ¬¡æ›´æ–°å›è°ƒ`AppWidgetProvider.onUpdate()`æ–¹æ³•

+ ç”¨æˆ·äº‹ä»¶æ›´æ–°
  - Appå†…çš„ç‚¹å‡»äº‹ä»¶
  - notificationç±»å‹çš„è¿œç«¯äº‹ä»¶

+ å¹¿æ’­äº‹ä»¶æ›´æ–°

4.1.3 é€šè¿‡å¹¿æ’­æ›´æ–°
+ æ›´æ–°é—´éš”
  å¹¿æ’­çš„ANRæ˜¯10ç§’ï¼Œå¦‚æœæ‰§è¡Œè€—æ—¶æ“ä½œè€ƒè™‘ä½¿ç”¨WorkManagerï¼Œæˆ–è€…ä½¿ç”¨`goAsync`æ–¹æ³•å¯ä»¥ä½¿å¹¿æ’­è¿è¡Œ30sï¼Œä½†ä¼šå µå¡åé¢çš„å¹¿æ’­ã€‚
+ æ›´æ–°ä¼˜å…ˆçº§
  ç”±äºå¹¿æ’­ğŸ“¢åœ¨åå°è¿›ç¨‹ï¼Œèµ„æºè¿‡è½½ä¼šå¯¼è‡´å»¶è¿Ÿï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‰å°è¿›ç¨‹æé«˜ä¼˜å…ˆçº§ã€‚ä¾‹å¦‚å½“ä½¿ç”¨`PendingIntent.getBroadcast` æ—¶ç»™Intentæ·»åŠ `Intent.FLAG_RECEIVER_FOREGROUND`


#### [1.App Widget Design Guidelines](https://developer.android.com/guide/practices/ui_guidelines/widget_design#anatomy)
#### [2.App widgets overview](https://developer.android.com/guide/topics/appwidgets/overview)




