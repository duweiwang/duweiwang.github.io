<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="SQLite是安卓平台存储成千上万数据的最佳方案，但是如此巨大的数据量，也可能导致性能问题。在Paging库之前，我们调研了很多现存的分页方案，尤其对SQLiteCursor的潜在缺陷进行了研究。这篇文章我们谈一下这个问题，并阐述是什么激励我们在架构组件Room和Paging库中使用小的查询。 SQLiteCursor 和 CursorAdapterSQLiteCursor是安卓SQLite数据库">
<meta property="og:type" content="article">
<meta property="og:title" content="android-database-large-query-2">
<meta property="og:url" content="https://wangduwei.top/android-database-large-query-2.html">
<meta property="og:site_name" content="蓝色的笔记本">
<meta property="og:description" content="SQLite是安卓平台存储成千上万数据的最佳方案，但是如此巨大的数据量，也可能导致性能问题。在Paging库之前，我们调研了很多现存的分页方案，尤其对SQLiteCursor的潜在缺陷进行了研究。这篇文章我们谈一下这个问题，并阐述是什么激励我们在架构组件Room和Paging库中使用小的查询。 SQLiteCursor 和 CursorAdapterSQLiteCursor是安卓SQLite数据库">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-01-03T07:38:16.000Z">
<meta property="article:modified_time" content="2025-01-03T07:38:16.308Z">
<meta property="article:author" content="wangduwei">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>android-database-large-query-2</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="蓝色的笔记本" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/android-github-source-shizuku.html"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/%E8%A3%85%E6%9C%BA%E6%B8%85%E5%8D%95.html"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wangduwei.top/android-database-large-query-2.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wangduwei.top/android-database-large-query-2.html&text=android-database-large-query-2"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wangduwei.top/android-database-large-query-2.html&is_video=false&description=android-database-large-query-2"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=android-database-large-query-2&body=Check out this article: https://wangduwei.top/android-database-large-query-2.html"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wangduwei.top/android-database-large-query-2.html&name=android-database-large-query-2&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wangduwei.top/android-database-large-query-2.html&t=android-database-large-query-2"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E5%92%8C-CursorAdapter"><span class="toc-number">1.</span> <span class="toc-text">SQLiteCursor 和 CursorAdapter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQLiteCursor%E5%88%86%E9%A1%B5%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number"></span> <span class="toc-text">SQLiteCursor分页导致的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E4%B8%8D%E4%BC%9A%E4%BF%9D%E6%8C%81%E4%BB%BB%E4%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E5%A4%84%E4%BA%8E%E6%89%93%E5%BC%80%E7%8A%B6%E6%80%81"><span class="toc-number">1.</span> <span class="toc-text">SQLiteCursor 不会保持任何数据库事务处于打开状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-getCount-%E6%98%AF%E5%BF%85%E9%9C%80%E7%9A%84%EF%BC%8C%E5%AE%83%E4%BC%9A%E6%89%AB%E6%8F%8F%E6%95%B4%E4%B8%AA%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.</span> <span class="toc-text">SQLiteCursor.getCount() 是必需的，它会扫描整个查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-getCount-%E5%A7%8B%E7%BB%88%E5%8A%A0%E8%BD%BD%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%A1%8C%E7%AA%97%E5%8F%A3"><span class="toc-number">3.</span> <span class="toc-text">SQLiteCursor.getCount() 始终加载第一个行窗口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%8A%A0%E8%BD%BD%E6%82%A8%E6%9C%AA%E8%A6%81%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">4.</span> <span class="toc-text">SQLiteCursor 可能会加载您未要求的数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E5%8A%A0%E8%BD%BD%E4%BD%8D%E7%BD%AE%E5%8F%AF%E8%83%BD%E6%97%A0%E6%B3%95%E9%A2%84%E6%B5%8B"><span class="toc-number">5.</span> <span class="toc-text">SQLiteCursor 加载位置可能无法预测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%B8%E6%A0%87%E9%9C%80%E8%A6%81%E5%85%B3%E9%97%AD"><span class="toc-number">6.</span> <span class="toc-text">游标需要关闭</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E4%B8%8D%E7%9F%A5%E9%81%93%E6%95%B0%E6%8D%AE%E5%B7%B2%E6%9B%B4%E6%94%B9"><span class="toc-number">7.</span> <span class="toc-text">SQLiteCursor 不知道数据已更改</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E8%BF%99%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number"></span> <span class="toc-text">避免这些问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Android-Platform-%E2%80%94-Android-P-Update"><span class="toc-number"></span> <span class="toc-text">Android Platform — Android P Update!</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number"></span> <span class="toc-text">参考</span></a>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        android-database-large-query-2
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">wangduwei</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-01-03T07:38:16.000Z" class="dt-published" itemprop="datePublished">2025-01-03</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>SQLite是安卓平台存储成千上万数据的最佳方案，但是如此巨大的数据量，也可能导致性能问题。<br>在Paging库之前，我们调研了很多现存的分页方案，尤其对SQLiteCursor的潜在缺陷进行了研究。<br>这篇文章我们谈一下这个问题，并阐述是什么激励我们在架构组件Room和Paging库中使用小的查询。</p>
<h5 id="SQLiteCursor-和-CursorAdapter"><a href="#SQLiteCursor-和-CursorAdapter" class="headerlink" title="SQLiteCursor 和 CursorAdapter"></a>SQLiteCursor 和 CursorAdapter</h5><p>SQLiteCursor是安卓SQLite数据库查询的返回值。它允许你以固定初始加载消耗来可视化大量查询结果集。</p>
<p>首次读操作初始化一个2MB的<code>CursorWindow</code>，并和查询结果一起返回。<br>每次你请求一个不存在的数据行时，SQLiteCursor都会刷新这个window。<br>因此，SQLiteCursor以固定大小页实现分页。</p>
<p>CursorAdapter在Android API-1.0就存在，它提供了一种简单的方式把来自游标的数据绑定在ListView的item上。<br>虽然它能很好的完成这中功能场景，但每当需要进行新的加载时，它就直接在UI线程上查询数据库。<br>这对于现代的响应性应用来说是不可接受的。<br>所以有人可能会问:我们不能有一个基于游标的适配器，在后台线程上加载吗?毕竟，SQLiteCursor内置了分页功能。</p>
<h4 id="SQLiteCursor分页导致的问题"><a href="#SQLiteCursor分页导致的问题" class="headerlink" title="SQLiteCursor分页导致的问题"></a>SQLiteCursor分页导致的问题</h4><h5 id="SQLiteCursor-不会保持任何数据库事务处于打开状态"><a href="#SQLiteCursor-不会保持任何数据库事务处于打开状态" class="headerlink" title="SQLiteCursor 不会保持任何数据库事务处于打开状态"></a>SQLiteCursor 不会保持任何数据库事务处于打开状态</h5><p>当我开始研究分页时，我对 SQLite 以及 Android 上的 Cursors 还不熟悉。<br>我只是假设 SQLiteCursor 在加载窗口后会暂停查询，并在需要下一个窗口时恢复。<br>这样，访问第 10 个窗口的效率就和访问第 1 个窗口一样高。<br>这是不正确的。每次读取新窗口时，查询都会从位置 0 重新开始，并一次跳过不需要填充窗口的行。<br>这是因为 SQLiteCursor 无法恢复查询。</p>
<p>这就像访问链接列表中的第 1000 到 1050 个项目一样 — 您必须跳过大量项目才能访问要加载的下一个页面。<br>在加载过程中，每个后续窗口都必须跳过越来越多的查询，这会减慢速度。<br>这相当于使用 SQL OFFSET 关键字跳过内容，这不是分页内容的最有效方法，但在依赖 SQLiteCursor 内分页时无法避免。<br>您可以在<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/fee4546fd648b519ad828ea1f950554c1054699d/core/jni/android_database_SQLiteConnection.cpp#695">此处</a>查看 SQLiteCursor 如何在新窗口中分页。</p>
<h5 id="SQLiteCursor-getCount-是必需的，它会扫描整个查询"><a href="#SQLiteCursor-getCount-是必需的，它会扫描整个查询" class="headerlink" title="SQLiteCursor.getCount() 是必需的，它会扫描整个查询"></a>SQLiteCursor.getCount() 是必需的，它会扫描整个查询</h5><p>在读取第一行之前，SQLiteCursor 会调用 getCount() 进行边界检查。<br>由于 SQLite 必须扫描查询的整个结果集才能对其进行计数（再次强调，就像链接列表一样），因此这可能会增加大量开销。<br>如果您要逐步将大型查询分页到 UI，以响应用户的滚动，您可能不需要知道查询的整个大小，因此计数会增加不必要的前期工作。</p>
<h5 id="SQLiteCursor-getCount-始终加载第一个行窗口"><a href="#SQLiteCursor-getCount-始终加载第一个行窗口" class="headerlink" title="SQLiteCursor.getCount() 始终加载第一个行窗口"></a>SQLiteCursor.getCount() 始终加载第一个行窗口</h5><p>作为计算计数的一部分，在扫描结果集时，SQLiteCursor 会主动从位置 0 填充其窗口，假设将需要查询中的第一个项目。</p>
<p>它会预加载这些项目，以便提前知道窗口可以容纳多少行（下面将详细介绍）。<br>如果您从查询的开头显示数据，则这种随机加载是合理的，但从保存的实例状态恢复的位置可能会使索引从列表的更下方开始，而初始窗口并不相关。<br>如果您想从第三个内容窗口显示数据，则必须先加载并丢弃 2MB 的数据。此计数行为的代码在<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/fee4546fd648b519ad828ea1f950554c1054699d/core/java/android/database/sqlite/SQLiteCursor.java#130">此处</a>。</p>
<h5 id="SQLiteCursor-可能会加载您未要求的数据"><a href="#SQLiteCursor-可能会加载您未要求的数据" class="headerlink" title="SQLiteCursor 可能会加载您未要求的数据"></a>SQLiteCursor 可能会加载您未要求的数据</h5><p>Cursor.moveToPosition() 保证请求的行在窗口中，但 SQLiteCursor 不会在请求的行开始填充。<br>由于 SQLiteCursor 不假设应用程序正在向前读取，因此当它距离目标位置约 ⅓ 个窗口时，它会开始填充窗口。<br>这意味着 CursorAdapter 在窗口加载后向后滚动几行不会触发另一个窗口加载。<br>这还意味着在第一次加载之后加载的每 2MB 数据都会加载您已经看到的 650KB 或更多数据。<br>您可以在<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/fee4546fd648b519ad828ea1f950554c1054699d/core/java/android/database/DatabaseUtils.java#742">此处</a>查看此行为的代码和解释。</p>
<h5 id="SQLiteCursor-加载位置可能无法预测"><a href="#SQLiteCursor-加载位置可能无法预测" class="headerlink" title="SQLiteCursor 加载位置可能无法预测"></a>SQLiteCursor 加载位置可能无法预测</h5><p>当 SQLiteCursor 尝试加载目标位置时，它会尝试提前启动窗口的 ⅓。这意味着它必须猜测一个窗口中可以容纳多少行。<br>为此，它使用在第一次窗口加载中填充的行数。不幸的是，这意味着如果您的行大小不一（例如，如果您嵌入任意长度的用户评论字符串），它的猜测可能是错误的。<br>SQLiteCursor 可能会低于目标位置，用内容填充窗口 - 然后丢弃所有内容，并重新开始填充。<br>例如，如果您正在扫描一个长查询并到达需要重新加载窗口的行，则加载可能只会捕获少量的新行。<br>清除窗口和重新启动代码在<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/fee4546fd648b519ad828ea1f950554c1054699d/core/jni/android_database_SQLiteConnection.cpp#709">这里</a>。</p>
<h5 id="游标需要关闭"><a href="#游标需要关闭" class="headerlink" title="游标需要关闭"></a>游标需要关闭</h5><p>必须使用 close() 方法关闭游标，因此无论它们存储在哪里，都必须有代码在不再需要它们时清理它们。<br>CursorAdapter 显然对此无能为力，而是将这一责任转交给应用程序开发人员。<br>要存储和重用游标，开发人员需要编写代码来处理活动停止等事件。</p>
<h5 id="SQLiteCursor-不知道数据已更改"><a href="#SQLiteCursor-不知道数据已更改" class="headerlink" title="SQLiteCursor 不知道数据已更改"></a>SQLiteCursor 不知道数据已更改</h5><p>SQLiteCursor 不会跟踪数据库在第一次窗口读取（和第一次计数）后是否已更改。<br>这意味着如果添加或删除了某些项目，SQLiteCursor 的缓存大小是不正确的——这对于边界检查和您希望加载的数据看起来一致都是一个问题。<br>这可能会导致在移动到不再存在的行时出现异常，或者在某些情况下导致数据不一致。<br>例如，如果您已经加载了第 N 行，并且在位置 0 处插入了一个新项目，然后您尝试读取第 N+1 行，那么您最终将再次加载旧的第 N 行。</p>
<h4 id="避免这些问题"><a href="#避免这些问题" class="headerlink" title="避免这些问题"></a>避免这些问题</h4><p>上述问题告诉我们，SQLCursor 无法扩展到具有数千个结果的查询。<br>幸运的是，这些问题都有一个简单的解决方法：小查询。<br>适合单个 CursorWindow 的查询可以避免所有问题，这就是我们在 Paging 和 Room 中如此推崇它们的原因。<br>通常将页面大小配置为仅 10 到 20 个项目，并且一次只查询这么多项目。</p>
<p>不过，选择页面大小需要考虑很多因素 — 窗口内较大的查询通常可以提高性能，较小的查询可以改善延迟和内存。<br>对于数据库不是瓶颈的较高列表项，10 个项目可能有意义，而如果您的列表项是小图块，或者您的查询成本很高，则 300 个项目可能更好。</p>
<p>如果您依赖 SQLiteCursor 的内部分页来延迟加载更大的结果集，我们建议您切换到另一种方法。<br>要么使用新的分页库及其与 Room Persistence Library 的集成，要么使用自定义实现，<br>您自己处理分页并确保您的查询结果足够小以适合单个 CursorWindow。<br>要使用新的分页库在 Room 中使用小查询对大型 SQL 查询结果进行分页，您可以更改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// regular list query — falls over with too much data</span></span><br><span class="line">    <span class="meta">@Query(&quot;SELECT * FROM user ORDER BY age DESC&quot;)</span></span><br><span class="line">    LiveData&lt;List&lt;User&gt;&gt; loadUsersByAgeDesc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// paged query — handles arbitrarily large queries</span></span><br><span class="line">    <span class="meta">@Query(&quot;SELECT * FROM user ORDER BY age DESC&quot;)</span></span><br><span class="line">    DataSource.<span class="function">Factory&lt;Integer, User&gt; <span class="title">loadUsersByAgeDesc</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将其传递给 LivePagedListBuilder 以获取可处理任意大结果集的 LiveData<PagedList>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LiveData&lt;PagedList&lt;User&gt;&gt; users = <span class="keyword">new</span> LivePagedListBuilder&lt;&gt;(</span><br><span class="line">        userDao.loadUsersByAgeDesc(), <span class="comment">/*page size*/</span> <span class="number">20</span>).build();</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们获取了分页查询结果的 LiveData 版本，当数据库发生变化时，这些结果还会更新任何已订阅的观察者。<br>要了解有关使用架构组件从 SQLite 进行分页的更多信息，请参阅分页简介和 Github 上的分页示例。</p>
<h4 id="Android-Platform-—-Android-P-Update"><a href="#Android-Platform-—-Android-P-Update" class="headerlink" title="Android Platform — Android P Update!"></a>Android Platform — Android P Update!</h4><p>自本文首次发布以来，我们在 Android P 开发者预览版中添加了新的 API 来改善上述行为。<br>该平台现在允许应用禁用 ⅓ 窗口启发式算法并配置 CursorWindow 大小。<br>小查询仍然是避免上述所有问题的好方法，但 P 的更改赋予了应用更多的控制权，我们很快将在 Room 中使用它们来尽可能提高查询效率。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://medium.com/androiddevelopers/large-database-queries-on-android-cb043ae626e8">原文</a></p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>加载评论需要在浏览器启用 JavaScript 脚本支持。</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E5%92%8C-CursorAdapter"><span class="toc-number">1.</span> <span class="toc-text">SQLiteCursor 和 CursorAdapter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQLiteCursor%E5%88%86%E9%A1%B5%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number"></span> <span class="toc-text">SQLiteCursor分页导致的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E4%B8%8D%E4%BC%9A%E4%BF%9D%E6%8C%81%E4%BB%BB%E4%BD%95%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E5%A4%84%E4%BA%8E%E6%89%93%E5%BC%80%E7%8A%B6%E6%80%81"><span class="toc-number">1.</span> <span class="toc-text">SQLiteCursor 不会保持任何数据库事务处于打开状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-getCount-%E6%98%AF%E5%BF%85%E9%9C%80%E7%9A%84%EF%BC%8C%E5%AE%83%E4%BC%9A%E6%89%AB%E6%8F%8F%E6%95%B4%E4%B8%AA%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.</span> <span class="toc-text">SQLiteCursor.getCount() 是必需的，它会扫描整个查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-getCount-%E5%A7%8B%E7%BB%88%E5%8A%A0%E8%BD%BD%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%A1%8C%E7%AA%97%E5%8F%A3"><span class="toc-number">3.</span> <span class="toc-text">SQLiteCursor.getCount() 始终加载第一个行窗口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%8A%A0%E8%BD%BD%E6%82%A8%E6%9C%AA%E8%A6%81%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">4.</span> <span class="toc-text">SQLiteCursor 可能会加载您未要求的数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E5%8A%A0%E8%BD%BD%E4%BD%8D%E7%BD%AE%E5%8F%AF%E8%83%BD%E6%97%A0%E6%B3%95%E9%A2%84%E6%B5%8B"><span class="toc-number">5.</span> <span class="toc-text">SQLiteCursor 加载位置可能无法预测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%B8%E6%A0%87%E9%9C%80%E8%A6%81%E5%85%B3%E9%97%AD"><span class="toc-number">6.</span> <span class="toc-text">游标需要关闭</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQLiteCursor-%E4%B8%8D%E7%9F%A5%E9%81%93%E6%95%B0%E6%8D%AE%E5%B7%B2%E6%9B%B4%E6%94%B9"><span class="toc-number">7.</span> <span class="toc-text">SQLiteCursor 不知道数据已更改</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%BF%E5%85%8D%E8%BF%99%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number"></span> <span class="toc-text">避免这些问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Android-Platform-%E2%80%94-Android-P-Update"><span class="toc-number"></span> <span class="toc-text">Android Platform — Android P Update!</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number"></span> <span class="toc-text">参考</span></a>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://wangduwei.top/android-database-large-query-2.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://wangduwei.top/android-database-large-query-2.html&text=android-database-large-query-2"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wangduwei.top/android-database-large-query-2.html&is_video=false&description=android-database-large-query-2"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=android-database-large-query-2&body=Check out this article: https://wangduwei.top/android-database-large-query-2.html"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://wangduwei.top/android-database-large-query-2.html&title=android-database-large-query-2"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://wangduwei.top/android-database-large-query-2.html&name=android-database-large-query-2&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://wangduwei.top/android-database-large-query-2.html&t=android-database-large-query-2"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    wangduwei
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?9f3c7bb2232e1e3fda4c019e4a4406c0";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'duweiwang/comments';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
