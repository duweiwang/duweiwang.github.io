<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wangduwei.top","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="耐心和坚持">
<meta property="og:type" content="website">
<meta property="og:title" content="蓝色的笔记本">
<meta property="og:url" content="https://wangduwei.top/archives/page/2/index.html">
<meta property="og:site_name" content="蓝色的笔记本">
<meta property="og:description" content="耐心和坚持">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="wangduwei">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wangduwei.top/archives/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>蓝色的笔记本</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9f3c7bb2232e1e3fda4c019e4a4406c0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="蓝色的笔记本" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">蓝色的笔记本</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录学习内容</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/flutter-state-bloc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/flutter-state-bloc.html" class="post-title-link" itemprop="url">flutter状态管理之BloC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-18 21:27:20" itemprop="dateCreated datePublished" datetime="2023-07-18T21:27:20+08:00">2023-07-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h4 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h4><p>Bloc = Business Logic Component</p>
<center>
    <img src="../images/flutter/bloc_architecture.png" width="60%"/>
</center>


<h4 id="二、结构"><a href="#二、结构" class="headerlink" title="二、结构"></a>二、结构</h4><p>BloC本身是一个独立的package、flutter-bloc基于BloC和Provider实现，其结构如下图所示：</p>
<center>
    <img src="../images/flutter/flutter_bloc.png" width="100%"/>
</center>

<h4 id="三、-实现"><a href="#三、-实现" class="headerlink" title="三、 实现"></a>三、 实现</h4><h5 id="3-1-BloC是基于dart的Stream-API实现的发布订阅模式。"><a href="#3-1-BloC是基于dart的Stream-API实现的发布订阅模式。" class="headerlink" title="3.1 BloC是基于dart的Stream API实现的发布订阅模式。"></a>3.1 BloC是基于dart的Stream API实现的发布订阅模式。</h5><ul>
<li>通过on方法订阅事件并提供处理函数，收到Event再将Event转换成State返回给Bloc</li>
<li>通过add方法发布事件</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Bloc</span>&lt;<span class="title">Event</span>, <span class="title">State</span>&gt; <span class="keyword">extends</span> <span class="title">BlocBase</span>&lt;<span class="title">State</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">BlocEventSink</span>&lt;<span class="title">Event</span>&gt; </span>&#123;</span><br><span class="line">     <span class="comment">//所有的订阅者</span></span><br><span class="line">     <span class="keyword">final</span> _subscriptions = &lt;StreamSubscription&lt;<span class="built_in">dynamic</span>&gt;&gt;[];</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">final</span> _eventController = StreamController&lt;Event&gt;.broadcast();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//添加订阅者</span></span><br><span class="line">     <span class="keyword">void</span> <span class="keyword">on</span>&lt;E <span class="keyword">extends</span> Event&gt;(</span><br><span class="line">       EventHandler&lt;E, State&gt; handler, &#123;</span><br><span class="line">       EventTransformer&lt;E&gt;? transformer,</span><br><span class="line">     &#125;) &#123;</span><br><span class="line">        <span class="comment">//这里开始了listen</span></span><br><span class="line">        <span class="keyword">final</span> subscription = xxx.listen(<span class="keyword">null</span>);</span><br><span class="line">        _subscriptions.add(subscription);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="meta">@override</span></span><br><span class="line">     <span class="keyword">void</span> add(Event event) &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">         onEvent(event);</span><br><span class="line">         _eventController.add(event);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (error, stackTrace) &#123;</span><br><span class="line">         onError(error, stackTrace);</span><br><span class="line">         <span class="keyword">rethrow</span>;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<center>
    <img src="../images/flutter/flutter-bloc-inner.png" width="50%"/>
</center>


<h5 id="3-1-事件和状态之间的转换"><a href="#3-1-事件和状态之间的转换" class="headerlink" title="3.1 事件和状态之间的转换"></a>3.1 事件和状态之间的转换</h5><ul>
<li>转换逻辑有业务层通过on()注入</li>
<li>内部的核心是_Emitter以及 <em>_eventController</em> 和 <em>_stateController</em></li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">dynamic</span> event) &#123;</span><br><span class="line">       <span class="keyword">void</span> onEmit(State state) &#123;</span><br><span class="line">         <span class="keyword">if</span> (isClosed) <span class="keyword">return</span>;</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.state == state &amp;&amp; _emitted) <span class="keyword">return</span>;</span><br><span class="line">         onTransition(Transition(</span><br><span class="line">           currentState: <span class="keyword">this</span>.state,</span><br><span class="line">           event: event <span class="keyword">as</span> E,</span><br><span class="line">           nextState: state,</span><br><span class="line">         ));</span><br><span class="line">         emit(state);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> emitter = _Emitter(onEmit);</span><br><span class="line">       <span class="keyword">final</span> controller = StreamController&lt;E&gt;.broadcast(</span><br><span class="line">         <span class="keyword">sync</span>: <span class="keyword">true</span>,</span><br><span class="line">         onCancel: emitter.cancel,</span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       <span class="keyword">void</span> handleEvent() <span class="keyword">async</span> &#123;</span><br><span class="line">         <span class="keyword">void</span> onDone() &#123;</span><br><span class="line">           emitter.complete();</span><br><span class="line">           _emitters.remove(emitter);</span><br><span class="line">           <span class="keyword">if</span> (!controller.isClosed) controller.close();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">           _emitters.add(emitter);</span><br><span class="line">           <span class="comment">//交给外部实现转换事件和状态</span></span><br><span class="line">           <span class="keyword">await</span> handler(event <span class="keyword">as</span> E, emitter);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (error, stackTrace) &#123;</span><br><span class="line">           onError(error, stackTrace);</span><br><span class="line">           <span class="keyword">rethrow</span>;</span><br><span class="line">         &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           onDone();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       handleEvent();</span><br><span class="line">       <span class="keyword">return</span> controller.stream;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>


<h4 id="四、参考"><a href="#四、参考" class="headerlink" title="四、参考"></a>四、参考</h4><p>主要参考和debug了bloc仓库里面examples中login的例子：<br><a target="_blank" rel="noopener" href="https://github.com/felangel/bloc/tree/master/examples/flutter_login">这里</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/flutter-state-provider.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/flutter-state-provider.html" class="post-title-link" itemprop="url">Flutter状态管理之Provider</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-01 15:30:50" itemprop="dateCreated datePublished" datetime="2023-06-01T15:30:50+08:00">2023-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-23 16:45:13" itemprop="dateModified" datetime="2024-05-23T16:45:13+08:00">2024-05-23</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>官方提供的一个简单的状态管理库。</p>
<p>关键点：</p>
<ul>
<li>提取状态:状态变量和UI分离</li>
<li>访问状态:将UI和状态建立联系</li>
<li>使用状态:读取状态变量</li>
</ul>
<center>
    <img src="../images/ui-equals-function-of-state.png" width="100%"/>
</center>

<h4 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h4><p>1、InheritedWidget</p>
<center>
    <img src="../images/flutter/flutter-inheritedwidget.png" width="100%"/>
</center>

<p>关键点：</p>
<ul>
<li>Element持有Widget对象</li>
<li>Element也是一个BuildContext对象</li>
<li>Element里面持有所有的<code>InheritedElement</code></li>
</ul>
<p>所以：通过BuildContext对象可以拿到所需的Widget对象，然后访问里面的数据。</p>
<p>父节点存放数据</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InheritedShareWidget</span> <span class="keyword">extends</span> <span class="title">InheritedWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> data;<span class="comment">//用于共享的数据</span></span><br><span class="line">  InheritedShareWidget(&#123;<span class="keyword">this</span>.data, Widget child&#125;) : <span class="keyword">super</span>(child: child);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//定义便捷方法，方便子控件获取共享数据</span></span><br><span class="line">  <span class="keyword">static</span> InheritedShareWidget of(BuildContext context) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">///<span class="markdown">当子控件依赖使用了我们的数据源时，数据变动会触发子控件中的 didChangeDependencies 方法</span></span></span><br><span class="line">    <span class="keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;InheritedShareWidget&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">///<span class="markdown">（前提：子控件使用了数据源）子控件中的 didChangeDependencies 方法不会被触发</span></span></span><br><span class="line">    <span class="comment">// return context.getElementForInheritedWidgetOfExactType&lt;InheritedShareWidget&gt;().widget;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> updateShouldNotify(<span class="keyword">covariant</span> InheritedShareWidget oldWidget) &#123;</span><br><span class="line">    <span class="keyword">return</span> oldWidget.data != <span class="keyword">this</span>.data;<span class="comment">//返回true时，才会通知子控件</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>子节点获取数据：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestShareChildWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> TestShareChildWidget(&#123;Key key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TestShareChildWidgetState createState() =&gt; _TestShareChildWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TestShareChildWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TestShareChildWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didChangeDependencies() &#123;</span><br><span class="line">    <span class="comment">///<span class="markdown">如build 方法中没有使用 InheritedShareWidget 的数据，那么它的didChangeDependencies()将不会被调用</span></span></span><br><span class="line">    <span class="keyword">super</span>.didChangeDependencies();</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;enter didChangeDependencies&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;enter child build&quot;</span>);</span><br><span class="line">    <span class="comment">//获取Inherited的共享数据：</span></span><br><span class="line">    <span class="keyword">final</span> data = InheritedShareWidget.of(context).data.toString();</span><br><span class="line">    <span class="keyword">return</span> Text(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>父子节点嵌套：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TestInheritedWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TestInheritedWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Center(</span><br><span class="line">      child: InheritedShareWidget(</span><br><span class="line">        data: count,</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: [</span><br><span class="line">            TestShareChildWidget(),</span><br><span class="line">            RaisedButton(</span><br><span class="line">                child: Text(<span class="string">&#x27;add&#x27;</span>),</span><br><span class="line">                onPressed: () &#123;</span><br><span class="line">                  setState(() &#123;</span><br><span class="line">                    ++count;</span><br><span class="line">                  &#125;);</span><br><span class="line">                &#125;)</span><br><span class="line">          ],),),);&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>2、InheritedProvider</p>
<center>
    <img src="../images/flutter/flutter-inheritedprovider.jpg" width="100%"/>
</center>

<p>关键点：</p>
<ul>
<li>通过<code>InheritedProvider</code>及其子类（如：ChangeNotifierProvider）来包裹其他Widget（child），其实是将child放入了<code>_InheritedProviderScope</code></li>
<li><code>_InheritedProviderScope</code>是一个<code>InheritedWidget</code>所以，<code>InheritedProvider</code>及其子类将会持有child对象，及其数据。</li>
</ul>
<h4 id="Provider的基本使用"><a href="#Provider的基本使用" class="headerlink" title="Provider的基本使用"></a>Provider的基本使用</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///<span class="markdown">这是状态</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="title">with</span> <span class="title">ChangeNotifier</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> name = <span class="string">&quot;ChangeNotifierProvider&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> changName(&#123;<span class="keyword">required</span> <span class="built_in">String</span> newName&#125;) &#123;</span><br><span class="line">    name = newName;</span><br><span class="line">    notifyListeners();<span class="comment">//1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MainApp(&#123;<span class="keyword">super</span>.key&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ChangeNotifierProvider&lt;Person&gt;(<span class="comment">///<span class="markdown">状态和UI之间建立联系</span></span></span><br><span class="line">      create: (ctx) =&gt; Person(),</span><br><span class="line">      child: <span class="keyword">const</span> MaterialApp(</span><br><span class="line">        home: ChangeNotifierProviderDemo(),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeNotifierProviderDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ChangeNotifierProviderDemo(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: <span class="keyword">const</span> Text(<span class="string">&quot;ChangeNotifierProvider&quot;</span>)),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.spaceEvenly,</span><br><span class="line">          children: [</span><br><span class="line">            Consumer&lt;Person&gt;(<span class="comment">///<span class="markdown">使用状态</span></span></span><br><span class="line">              builder: (ctx, person, child) =&gt; Text(person.name),</span><br><span class="line">            ),</span><br><span class="line">            Consumer&lt;Person&gt;(</span><br><span class="line">              builder: (ctx, person, child) &#123;</span><br><span class="line">                <span class="keyword">return</span> ElevatedButton(</span><br><span class="line">                  onPressed: () =&gt; person.changName(newName: <span class="string">&quot;ChangeNotifierProvider更新了&quot;</span>),</span><br><span class="line">                  child: <span class="keyword">const</span> Text(<span class="string">&quot;点击更新&quot;</span>),</span><br><span class="line">                );&#125;,),],),),);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="Provider的类结构"><a href="#Provider的类结构" class="headerlink" title="Provider的类结构"></a>Provider的类结构</h4><center>
    <img src="../images/flutter/flutter_provider.png" width="100%"/>
</center>


<p>3.1 InheritedProvider的子类只是具体功能的实现，基础逻辑封装在InheritedProvider中<br>3.2 InheritedProvider将职责转嫁给_InheritedProviderScope而_InheritedProviderScope是一个InheritedWidget</p>
<h4 id="如何实现监听"><a href="#如何实现监听" class="headerlink" title="如何实现监听"></a>如何实现监听</h4><p>1、数据实现了ChangeNotifier，变更后调用notifyListeners(),触发回调。</p>
<p>2、ChangeNotifierProvider继承自ListenableProvider，ListenableProvider构建时开启监听：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> VoidCallback _startListening(</span><br><span class="line">  InheritedContext e,</span><br><span class="line">  Listenable? value,</span><br><span class="line">) &#123;</span><br><span class="line">  value?.addListener(e.markNeedsNotifyDependents);</span><br><span class="line">  <span class="keyword">return</span> () =&gt; value?.removeListener(e.markNeedsNotifyDependents);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>class InheritedContext extends BuildContext{<br>    void markNeedsNotifyDependents();<br>}</p>
<p>3、markNeedsNotifyDependents是<code>InheritedContext</code>中的方法，其实现类是<code>_InheritedProviderScopeElement</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> markNeedsNotifyDependents() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_isNotifyDependentsEnabled) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    markNeedsBuild();</span><br><span class="line">    _shouldNotifyDependents = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>4、markNeedsBuild是Element的方法：标记需要重新构建</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> markNeedsBuild() &#123;</span><br><span class="line">    ...  </span><br><span class="line">    <span class="keyword">if</span> (dirty) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    _dirty = <span class="keyword">true</span>;</span><br><span class="line">    owner!.scheduleBuildFor(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="局部更新"><a href="#局部更新" class="headerlink" title="局部更新"></a>局部更新</h4><p>Provider的<code>Selector</code>提供了缓存Widget的功能，当Widget没有变化时，将直接返回缓存，否则重新build。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Selector0State</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">SingleChildState</span>&lt;<span class="title">Selector0</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">  T? value;</span><br><span class="line">  Widget? cache;<span class="comment">//这是缓存</span></span><br><span class="line">  Widget? oldWidget;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget buildWithChild(BuildContext context, Widget? child) &#123;</span><br><span class="line">    <span class="keyword">final</span> selected = widget.selector(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> shouldInvalidateCache = oldWidget != widget ||</span><br><span class="line">        (widget._shouldRebuild != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            widget._shouldRebuild!(value <span class="keyword">as</span> T, selected)) ||</span><br><span class="line">        (widget._shouldRebuild == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            !<span class="keyword">const</span> DeepCollectionEquality().equals(value, selected));</span><br><span class="line">    <span class="keyword">if</span> (shouldInvalidateCache) &#123;<span class="comment">//需要重新构建</span></span><br><span class="line">      value = selected;</span><br><span class="line">      oldWidget = widget;</span><br><span class="line">      cache = widget.builder(</span><br><span class="line">        context,</span><br><span class="line">        selected,</span><br><span class="line">        child,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> debugFillProperties(DiagnosticPropertiesBuilder properties) &#123;</span><br><span class="line">    <span class="keyword">super</span>.debugFillProperties(properties);</span><br><span class="line">    properties.add(DiagnosticsProperty&lt;T&gt;(<span class="string">&#x27;value&#x27;</span>, value));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7067356022272163847#heading-16">https://juejin.cn/post/7067356022272163847#heading-16</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/flutter-widget-row.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/flutter-widget-row.html" class="post-title-link" itemprop="url">Flutter Widget之Row、Column</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-07 16:54:08" itemprop="dateCreated datePublished" datetime="2023-03-07T16:54:08+08:00">2023-03-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>385</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Row和Column分别在横向和纵向对子Widget进行布局。"><a href="#Row和Column分别在横向和纵向对子Widget进行布局。" class="headerlink" title="Row和Column分别在横向和纵向对子Widget进行布局。"></a>Row和Column分别在横向和纵向对子Widget进行布局。</h4><ul>
<li>对于Row来讲，横向是主轴，纵向是交叉轴。</li>
<li>对于Column来讲，横向是交叉轴，纵向是主轴。</li>
</ul>
<p>针对主轴和交叉轴，不同大小的子Widget该如何对齐呢？Flutter提供了下列属性：</p>
<h4 id="MainAxisAlignment：主轴对齐方式"><a href="#MainAxisAlignment：主轴对齐方式" class="headerlink" title="MainAxisAlignment：主轴对齐方式"></a>MainAxisAlignment：主轴对齐方式</h4><table>
<thead>
<tr>
<th>属性值</th>
<th>解释</th>
<th>图示</th>
</tr>
</thead>
<tbody><tr>
<td>start</td>
<td>靠近主轴的开始</td>
<td><center><img src="../images/flutter/flutter_row_start.png"/></center></td>
</tr>
<tr>
<td>end</td>
<td>靠近主轴的末尾</td>
<td><center><img src="../images/flutter/flutter_row_end.png"/></center></td>
</tr>
<tr>
<td>center</td>
<td>靠近主轴中间</td>
<td><center><img src="../images/flutter/flutter_row_center.png"/></center></td>
</tr>
<tr>
<td>spaceBetween</td>
<td>剩余空间在孩子中间平分</td>
<td><center><img src="../images/flutter/flutter_row_space_between.png"/></center></td>
</tr>
<tr>
<td>spaceAround</td>
<td>剩余空间围绕孩子平分</td>
<td><center><img src="../images/flutter/flutter_row_space_around.png"/></center></td>
</tr>
<tr>
<td>spaceEvenly</td>
<td>剩余空间在孩子之间均等分配</td>
<td><center><img src="../images/flutter/flutter_row_space_evenly.png"/></center></td>
</tr>
</tbody></table>
<h4 id="CrossAxisAlignment-交叉轴对齐方式"><a href="#CrossAxisAlignment-交叉轴对齐方式" class="headerlink" title="CrossAxisAlignment:交叉轴对齐方式"></a>CrossAxisAlignment:交叉轴对齐方式</h4><table>
<thead>
<tr>
<th>属性值</th>
<th>解释</th>
<th>图示</th>
</tr>
</thead>
<tbody><tr>
<td>start</td>
<td>左对齐(Column)或上对齐(Row)</td>
<td><center><img src="../images/flutter/cross_axis_start.jpeg" width="50%"/></center></td>
</tr>
<tr>
<td>end</td>
<td>右对齐(Column)或下对齐(Row)</td>
<td><center><img src="../images/flutter/cross_axis_end.jpeg" width="50%"/></center></td>
</tr>
<tr>
<td>center</td>
<td>中间对齐</td>
<td><center><img src="../images/flutter/cross_axis_center.jpeg" width="50%"/></center></td>
</tr>
<tr>
<td>stretch</td>
<td>拉伸</td>
<td><center><img src="../images/flutter/cross_axis_stretch.jpeg" width="50%"/></center></td>
</tr>
<tr>
<td>baseline</td>
<td>基线对齐,需要配合textBaseline属性使用</td>
<td><center><img src="../images/flutter/cross_axis_baseline.jpg" width="50%"/></center></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/%E3%80%8A%E6%80%9D%E8%80%83%EF%BC%8C%E5%BF%AB%E4%B8%8E%E6%85%A2%E3%80%8B-%E7%AC%AC7%E7%AB%A0-%E5%AD%97%E6%AF%8DB%E4%B8%8E%E6%95%B0%E5%AD%9713.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/%E3%80%8A%E6%80%9D%E8%80%83%EF%BC%8C%E5%BF%AB%E4%B8%8E%E6%85%A2%E3%80%8B-%E7%AC%AC7%E7%AB%A0-%E5%AD%97%E6%AF%8DB%E4%B8%8E%E6%95%B0%E5%AD%9713.html" class="post-title-link" itemprop="url">《思考，快与慢》 第7章 字母B与数字13</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-09 20:52:58" itemprop="dateCreated datePublished" datetime="2022-10-09T20:52:58+08:00">2022-10-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reading/" itemprop="url" rel="index"><span itemprop="name">Reading</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>814</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本章包含三节：</p>
<ul>
<li>是什么让你相信了那些荒谬之辞</li>
<li>光环效应与群体智慧</li>
<li>眼见为实的想法往往让我们仓促作出决定</li>
</ul>
<h4 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h4><center>
    <img src="../images/b_and_13.jpg" width="50%"/>
</center>

<blockquote>
<p>“同样的形状在字母的环境下就容易被看做是字母，在数字的环境下就容易被看做是数字”</p>
</blockquote>
<blockquote>
<p>“你过早地对它的“身份”下了结论，并且根本意识不到你已经赋予了某种歧义以解释。”</p>
</blockquote>
<blockquote>
<p>“你作了一个确切的选择，但自己却没有意识到自己这样做了”</p>
</blockquote>
<h4 id="是什么让你相信了那些荒谬之辞"><a href="#是什么让你相信了那些荒谬之辞" class="headerlink" title="是什么让你相信了那些荒谬之辞"></a>是什么让你相信了那些荒谬之辞</h4><blockquote>
<p>联想记忆的运作是导致“确认偏误”的原因之一</p>
</blockquote>
<p>“你试试他给出的例子：“白鱼吃糖果。”<br>你有可能意识到一个关于鱼和糖果的模糊印象，这个印象的产生过程，就是联想记忆自动搜索“鱼”和“糖果”这两个概念之间各种联系的过程，这一过程会使这种很荒唐的说法看起来竟有些道理了。</p>
<h4 id="光环效应与群体智慧"><a href="#光环效应与群体智慧" class="headerlink" title="光环效应与群体智慧"></a>光环效应与群体智慧</h4><p>“如果你赞同一个总统的政见，你可能也会喜爱他的声音及着装。喜爱（或讨厌）某个人就会喜爱（或讨厌）这个人的全部—包括你还没有观察到的方面—这种倾向就叫做光环效应”</p>
<p>Alan：聪明—勤奋—冲动—爱挑剔—固执—忌妒心强<br>Ben：忌妒心强—固执—爱挑剔—冲动—勤奋—聪明</p>
<p>“光环效应注重第一印象，而后续信息在很大程度上都被消解掉了”</p>
<h4 id="眼见为实的想法往往让我们仓促作出决定"><a href="#眼见为实的想法往往让我们仓促作出决定" class="headerlink" title="眼见为实的想法往往让我们仓促作出决定"></a>眼见为实的想法往往让我们仓促作出决定</h4><p>“所有受试者都充分了解了整个过程，那些只听到其中一方辩词的受试者能够很轻松地为另一方写出辩词。然而，片面的证据陈述对判断有着重大影响。<br>另外，只掌握一方证据的受试者比掌握了双方证据的受试者更有自信。”</p>
<p>“这正说明人们根据已有信息“勾勒出的故事的连贯性增强了他们的自信心。一个好故事最重要的是信息的前后一致性，而不是其完整性。<br>的确，你常会发现：知道得很少反而可以把已知的所有事物都囊括进连贯的思维模式中。</p>
<p>“眼见即为事实的理念有助于达成连贯性和认知放松的状态，从而使我们相信某个陈述是真实的。这一理念解释了我们能够快速思考的原因，解释了我们是如何弄清楚一个复杂领域中那些信息片段的含义的。很多时候，我们拼凑出的连贯情节与事实是无限接近的，完全可以用来支持理性活动”</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/ep-good-developer-manifesto.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ep-good-developer-manifesto.html" class="post-title-link" itemprop="url">开发者七条</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-09 17:20:32" itemprop="dateCreated datePublished" datetime="2022-10-09T17:20:32+08:00">2022-10-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>901</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>软件开发不只是API调用和基础语法，以下是应用开发的全貌：</p>
<h4 id="一、相信数据"><a href="#一、相信数据" class="headerlink" title="一、相信数据"></a>一、相信数据</h4><p>如果你觉得系统正常运转，你应该拿出数据支撑你的想法。更重要的是，当研究证明你是错的时，你应该欣然接受实事。<br>这就需要做测试来验证你的代码，也需要一些流程来生成对应的数据。<br>你做的任何事都需要数据来辅助你下一步的决策。否则你将不知道自己做的事是对还是错。</p>
<h4 id="二、软件开发不只是编码"><a href="#二、软件开发不只是编码" class="headerlink" title="二、软件开发不只是编码"></a>二、软件开发不只是编码</h4><p>除了编码，开发人员还需要协调、沟通、分析、设计、测试、项目管理等</p>
<h4 id="三、代码就是和人沟通"><a href="#三、代码就是和人沟通" class="headerlink" title="三、代码就是和人沟通"></a>三、代码就是和人沟通</h4><p>如果我们真的只是“为计算机编程”，那么我们都将编写字节码。计算机最能理解它。但我们用的是一种“折衷”语言，这种语言其他人可以理解，也可以翻译成计算机可以理解的东西。</p>
<p>好的软件开发是一个交流的过程。这是为了确保人们理解你在做什么。你的工作是与下一个阅读它的人交流。找到最好的表达方式可能需要同理心。</p>
<h4 id="四、好的流程很重要"><a href="#四、好的流程很重要" class="headerlink" title="四、好的流程很重要"></a>四、好的流程很重要</h4><p>康威定律预言，你的软件注定要反映你的团队及其沟通结构。流程是沟通的结构。</p>
<p>想象一下一架起飞的飞机:飞行员、副驾驶、机组人员和空中交通管制人员之间有一段非常有条理的对话。这确保了每个人都关注关键问题，每个人都有发言权。“机翼还在飞机上吗?””“检查。“没有别的飞机挡住我们的去路吗?”“可以起飞了。”</p>
<h4 id="五、用结果证明自己，而不是身份低位"><a href="#五、用结果证明自己，而不是身份低位" class="headerlink" title="五、用结果证明自己，而不是身份低位"></a>五、用结果证明自己，而不是身份低位</h4><p>最糟糕的开发组织要么等级森严，要么每个开发人员有太多老板。这通常反映了管理者对地位的渴望。</p>
<p>考虑“角色”，而不是“地位”。我工作过的最好的组织都首先认可那些推动事情的人，而不管他们在组织中扮演什么角色。</p>
<h4 id="六、每个人都能从别人那学到"><a href="#六、每个人都能从别人那学到" class="headerlink" title="六、每个人都能从别人那学到"></a>六、每个人都能从别人那学到</h4><p>如果您认为人们的种族、性别或其他因素是判断他们的技能或他们必须教给您的东西的好方法，那么您就限制了自己作为软件开发人员的发展。</p>
<h4 id="七、测试你所有的猜想，并随时准备改变这些猜想"><a href="#七、测试你所有的猜想，并随时准备改变这些猜想" class="headerlink" title="七、测试你所有的猜想，并随时准备改变这些猜想"></a>七、测试你所有的猜想，并随时准备改变这些猜想</h4><p>当指导年轻的开发者时，我总是强调你不应该证明自己是对的，而应该证明自己是错的。我还鼓励他们用证明自己正确的热情去做这件事。</p>
<p>逻辑理论往往有一种方法可以证明你是错的。如果没有，这可能不是一个很好的理论。如果你不能证明它是错的，那么，只有那时，也许你可以试着证明它是对的。这与“相信数据”类似，但这不仅仅是关于数据，还有你使用数据的方式。</p>
<p><a target="_blank" rel="noopener" href="https://www.infoworld.com/article/3214481/the-good-software-development-manifesto.html">参考来源</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/android-aosp-event-loop.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/android-aosp-event-loop.html" class="post-title-link" itemprop="url">Android消息机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-20 15:34:15" itemprop="dateCreated datePublished" datetime="2022-06-20T15:34:15+08:00">2022-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h4 id="一、相关类和结构"><a href="#一、相关类和结构" class="headerlink" title="一、相关类和结构"></a>一、相关类和结构</h4><center>
    <img src="../images/android-basic-eventloop.png" width="100%"/>
</center>

<h4 id="二、基本使用"><a href="#二、基本使用" class="headerlink" title="二、基本使用"></a>二、基本使用</h4><h5 id="2-1-主线程的事件循环"><a href="#2-1-主线程的事件循环" class="headerlink" title="2.1 主线程的事件循环"></a>2.1 主线程的事件循环</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> <span class="keyword">extends</span> <span class="title">ClientTransactionHandler</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ActivityThreadInternal</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//...</span></span><br><span class="line">         Looper.prepareMainLooper();</span><br><span class="line">         </span><br><span class="line">         Looper.loop();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-2-构建自己的事件循环"><a href="#2-2-构建自己的事件循环" class="headerlink" title="2.2 构建自己的事件循环"></a>2.2 构建自己的事件循环</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">      <span class="keyword">public</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          Looper.prepare();</span><br><span class="line"></span><br><span class="line">          mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                  <span class="comment">// process incoming messages here</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          Looper.loop();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="三、原理剖析"><a href="#三、原理剖析" class="headerlink" title="三、原理剖析"></a>三、原理剖析</h4><h5 id="3-1-构建事件循环"><a href="#3-1-构建事件循环" class="headerlink" title="3.1 构建事件循环"></a>3.1 构建事件循环</h5><center>
    <img src="../images/android-basic-eventloop-start.png" width="70%"/>
</center>


<h5 id="3-2-发送消息"><a href="#3-2-发送消息" class="headerlink" title="3.2 发送消息"></a>3.2 发送消息</h5><center>
    <img src="../images/android-basic-eventloop-send.png" width="70%"/>
</center>


<h5 id="3-3-消息执行"><a href="#3-3-消息执行" class="headerlink" title="3.3 消息执行"></a>3.3 消息执行</h5><center>
    <img src="../images/android-basic-eventloop-callback.png" width="50%"/>
</center>

<h5 id="3-4-同步屏障"><a href="#3-4-同步屏障" class="headerlink" title="3.4 同步屏障"></a>3.4 同步屏障</h5><h6 id="3-4-1-消息的分类"><a href="#3-4-1-消息的分类" class="headerlink" title="3.4.1 消息的分类"></a>3.4.1 消息的分类</h6><ul>
<li>同步消息</li>
<li>异步消息</li>
<li>屏障消息</li>
</ul>
<h6 id="3-4-2-同步屏障是什么"><a href="#3-4-2-同步屏障是什么" class="headerlink" title="3.4.2 同步屏障是什么"></a>3.4.2 同步屏障是什么</h6><p>一种特殊的Message，其target=null</p>
<h6 id="3-4-3-同步屏障工作原理"><a href="#3-4-3-同步屏障工作原理" class="headerlink" title="3.4.3 同步屏障工作原理"></a>3.4.3 同步屏障工作原理</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">            Message msg = mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;<span class="comment">//碰到同步屏障</span></span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                <span class="comment">// do while循环遍历消息链表</span></span><br><span class="line">                <span class="comment">// 跳出循环时，msg指向离表头最近的一个异步消息</span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                    <span class="comment">//...</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//将msg从消息链表中移除</span></span><br><span class="line">                        prevMsg.next = msg.next;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mMessages = msg.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Returning message: &quot;</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="comment">//返回异步消息</span></span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当设置了同步屏障之后，next函数将会忽略所有的同步消息，返回异步消息。换句话说就是，设置了同步屏障之后，Handler只会处理异步消息。再换句话说，同步屏障为Handler消息机制增加了一种简单的优先级机制，异步消息的优先级要高于同步消息。</p>
<h6 id="3-4-4-实际应用"><a href="#3-4-4-实际应用" class="headerlink" title="3.4.4 实际应用"></a>3.4.4 实际应用</h6><p>Android应用框架中为了更快的响应UI刷新事件在ViewRootImpl.scheduleTraversals中使用了同步屏障</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//设置同步障碍，确保mTraversalRunnable优先被执行</span></span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        <span class="comment">//内部通过Handler发送了一个异步消息</span></span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">            scheduleConsumeBatchedInput();</span><br><span class="line">        &#125;</span><br><span class="line">        notifyRendererOfFramePending();</span><br><span class="line">        pokeDrawLockIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="四、其他"><a href="#四、其他" class="headerlink" title="四、其他"></a>四、其他</h4><p><a target="_blank" rel="noopener" href="https://www.jxhs.me/2021/04/08/linux%E5%86%85%E6%A0%B8Epoll-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">Epoll 实现原理</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LoyenWang/p/12622904.html">Linux select/poll机制原理分析</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/econonmics-roa-roe-roic-roce.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/econonmics-roa-roe-roic-roce.html" class="post-title-link" itemprop="url">投资回报率</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-13 17:04:39" itemprop="dateCreated datePublished" datetime="2022-06-13T17:04:39+08:00">2022-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BB%8F%E6%B5%8E%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">经济学</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h4><ul>
<li>资产回报率（ROA）</li>
<li>净资产回报率（ROE）</li>
<li>投入资本回报率（ROIC）</li>
<li>使用资本回报率（ROCE）</li>
</ul>
<p>不同的回报率，实际上是衡量公司的不同视角。</p>
<h4 id="二、资产回报率（ROA）"><a href="#二、资产回报率（ROA）" class="headerlink" title="二、资产回报率（ROA）"></a>二、资产回报率（ROA）</h4><h5 id="2-1-基本概念"><a href="#2-1-基本概念" class="headerlink" title="2.1 基本概念"></a>2.1 基本概念</h5><p><strong>运用全部资金获取利润能力的集中体现</strong></p>
<center>
    <img src="../images/ec-roa.png" width="50%"/>
</center>

<p>$$<br>    ROA=\frac{净利润}{总资产}<br>$$</p>
<h5 id="2-2-概念拆分"><a href="#2-2-概念拆分" class="headerlink" title="2.2 概念拆分"></a>2.2 概念拆分</h5><p>$$<br>    ROA = 净利润率NPM * 资产利用率AU = \frac{净利润}{营业总收入} * \frac{营业总收入}{总资产} = \frac{（主营业务收入+非主营业务收入）}{总资产}<br>$$</p>
<h5 id="2-3-概念理解"><a href="#2-3-概念理解" class="headerlink" title="2.3 概念理解"></a>2.3 概念理解</h5><p>ROA这个回报率衡量的是资产的回报率。<br>但是一个公司资产负债表上的资产价值更多的是反映了历史而不是当前，<br>而且不同的行业的ROA具有不可比性。<br>最简单的例子，很多类金融企业有无息流动负债，增加了总资产，降低了ROA，<br>但是无偿使用上下游资金实际上是公司有竞争力的体现。</p>
<h4 id="三、净资产回报率（ROE）"><a href="#三、净资产回报率（ROE）" class="headerlink" title="三、净资产回报率（ROE）"></a>三、净资产回报率（ROE）</h4><h5 id="2-1-基本概念-1"><a href="#2-1-基本概念-1" class="headerlink" title="2.1 基本概念"></a>2.1 基本概念</h5><p>ROE的视角是从股东的角度看问题，单纯从股权的角度衡量回报，而不考虑公司的资本结构及负债情况。衡量公司赚钱的效率。</p>
<center>
    <img src="../images/ec-roe.png" width="50%"/>
</center>

<p>$$<br>    净资产收益率 = \frac{净利润}{净资产}<br>$$</p>
<blockquote>
<p>A公司：10亿净资产赚2亿。ROE = 20%<br>B公司：50亿净资产赚5亿。ROE = 10%</p>
</blockquote>
<h5 id="2-2-概念拆分-1"><a href="#2-2-概念拆分-1" class="headerlink" title="2.2 概念拆分"></a>2.2 概念拆分</h5><p>$$<br>    净资产收益率 = \frac{净利润}{净资产} = \frac{净利润}{营业收入} * \frac{营业收入}{总资产} * \frac{总资产}{净资产}<br>$$</p>
<p>$$<br>    净资产收益率 = 净利润 * 资产周转率 * 权益乘数<br>$$</p>
<p>$$<br>    权益乘数 = \frac{总资产}{净资产}<br>$$</p>
<p>$$<br>    资产周转率 = \frac{营业收入}{总资产}<br>$$</p>
<p>影响因素：</p>
<ul>
<li>净利润：反应盈利能力</li>
<li>资产周转率：反应资产使用效率</li>
<li>权益乘数：反应负债程度</li>
</ul>
<p>提升ROE的办法：</p>
<ul>
<li>提高周转率</li>
<li>廉价的债务杠杆</li>
<li>更高的债务杠杆</li>
<li>更低的所得税</li>
<li>更高的运营利润率</li>
</ul>
<h5 id="2-3-概念理解-1"><a href="#2-3-概念理解-1" class="headerlink" title="2.3 概念理解"></a>2.3 概念理解</h5><p>ROE对股东来说意义最大，是股票复利增长的源泉。<br>ROE可以在不同行业与不同企业之间横向比较。<br>相当于股票这种“股权债券”的收益率。<br>对投资人来说无论是投资铁路还是互联网，都相当于是买了“股权债券”。<br>在同等风险情况下，当然是收益率越高越好。<br>而且，ROE还可以与政府债券、企业债券的收益率跨资产类别横向比较。</p>
<h5 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h5><p>ROE的问题在于无法反映债务杠杆对净利润的影响。<br>如果一个企业借更多的债，一般就能产生更多净利润，ROE也会提高。<br>但是这样的提高是以牺牲企业经营稳健程度为代价的。<br>因此，分析ROE一定要结合杜邦公式，并与同行业进行比较。</p>
<hr>
<h4 id="四、投入资本回报率（ROIC）"><a href="#四、投入资本回报率（ROIC）" class="headerlink" title="四、投入资本回报率（ROIC）"></a>四、投入资本回报率（ROIC）</h4><center>
    <img src="../images/ec-roic-1.png" width="50%"/>
</center>


<p>ROIC是从资本的角度看问题，综合考虑股权与债权，衡量投资的效率。与ROIC对应的是平均资金成本（WACC）。如果ROIC小于WACC，就说明投入资本的回报小于平均资本成本，公司是在浪费资本。</p>
<p>ROIC=息税前收益（EBIT）*（1-税率）/投入资本</p>
<p>$$<br>    ROIC = \frac{息税前收益（EBIT）*（1-税率）}{投入资本}<br>$$</p>
<p>$$<br>    投入资本 = 股东权益 + 有息负债<br>$$</p>
<p>$$<br>    ROIC = \frac{EBIT（1-税率）}{有息负债+权益）}<br>$$</p>
<p>公式中分子是指一家公司如果完全以权益筹资所应报告的净利润，分母是指公司所有要求回报的现金来源的总和，也就是说，尽管应付账款也是公司的一种现金来源，但因其未附带明确的成本而被排除在外。实质上，ROIC是生产经营活动中所有投入资本赚取的收益率，而不论这些投入资本是被称为债务还是权益。</p>
<center>
    <img src="../images/ec-roic-2.png" width="50%"/>
</center>


<p>投入资本回报率是EBIT（税及利息前盈利）经过税率调整比上投入的资本，也就是股东权益加负债减去非运营现金和投资。之所以用EBIT就是因为利息是由债务产生的，是对债权的回报，当计算债权加股权的总的投入资本的回报率时应该把利息加回来。</p>
<p>投入资本也可以表示为净运营资金（流动运营资产减去无息流动负债）加固定资产，加无形资产及商誉，加其他运营资产。</p>
<p>ROIC的问题在于没有考虑无息流动负债的影响。ROIC实际上是衡量投入的总资本的使用效率，与平均资金成本WACC相结合可以揭示一个企业的真正效率。ROIC &lt; WACC 是卖空大师Jim Chanos经常用来寻找卖空对象的一个重要指标。</p>
<p>但是，ROIC对于类金融企业的分析不太容易。一些类金融企业如国美、苏宁、联想、格力等，占用了大量上下游资金作为无息流动负债，因此提高了EBIT。但是，和有息负债一样，无息负债也存在风险。虽然不用付利息，但是一旦经营形式改变，这些资金很有可能像“热钱”一样撤走。国美在黄光裕被捕后就陷入了这样的危险境地，只要供应商撤资，国美就会破产。这些企业虽然ROIC很高，但是静态不稳定，动态稳定。</p>
<h4 id="五、使用资本回报率-ROCE-Return-on-Capital-Employed"><a href="#五、使用资本回报率-ROCE-Return-on-Capital-Employed" class="headerlink" title="五、使用资本回报率(ROCE = Return on Capital Employed)"></a>五、使用资本回报率(ROCE = Return on Capital Employed)</h4><center>
    <img src="../images/ec-roce.png" width="50%"/>
</center>

<p>$$<br>    ROCE資本運用報酬率 = \frac{息税前收益（EBIT）}{已動用資本(Capital Employed)}<br>$$</p>
<p>$$<br>    已動用資本 = 總資產 -流動負債<br>$$</p>
<p>ROCE实质上是从企业价值（EnterpriseValue，EV）的角度，从并购的角度看资本的回报率。ROCE中的使用资本是股东权益加有息负债再减现金。这实质上相当于1倍PB并购企业时的企业价值。因为如果你以1倍PB并购一个企业，你要付的价格就是股东权益，并且承担所有负债，但也获得所有现金。</p>
<p>ROCE实际上是从一个并购者的角度看问题，如果并购一个企业，付出企业价值EV后的回报率有多少？这与ROIC最大的不同是：ROIC从企业的拥有者的角度看问题，衡量投入资本的使用效率与回报率。而ROCE是从潜在并购者的角度看问题，衡量如果1倍PB并购付出EV后的回报率，也就是并购到底值不值的问题。这接近价值投资买股票就是买公司的原则。</p>
<p>ROCE：使用资本回报率是EBIT（税及利息前盈利）比上使用的资本，也就是所有有息负债加上股东权益。这个指标与ROIC相近，但是使用的是EBIT而没有经过税率调整，因此可以用来比较不同税率的企业。ROCE也容易忽视公司无息负债的融资效应。</p>
<p>总之，本质上是从四个不同的视角看问题，衡量不同的指标。只有全面综合考虑，才能更全面的看问题</p>
<h4 id="六、参考来源"><a href="#六、参考来源" class="headerlink" title="六、参考来源"></a>六、参考来源</h4><p><a target="_blank" rel="noopener" href="https://xueqiu.com/1484348349/107966592">雪球-老韩7</a><br><a target="_blank" rel="noopener" href="https://rich01.com/what-is-roce/">ROCE資本運用報酬率</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/kotlin-lang-flow-under-the-hood.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/kotlin-lang-flow-under-the-hood.html" class="post-title-link" itemprop="url">Kotlin Flow的工作原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-25 11:08:23" itemprop="dateCreated datePublished" datetime="2022-05-25T11:08:23+08:00">2022-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>我们有一个会被重复调用的lambda表达式：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> f: () -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">        print(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    f() <span class="comment">// ABC</span></span><br><span class="line">    f() <span class="comment">// ABC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们给这个lambda加个参数：<code>(String) -&gt; Unit</code> ,因为参数是个函数，为了能调用到函数，我们把它叫做<code>emit</code>吧：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> f: ((String) -&gt; <span class="built_in">Unit</span>) -&gt; <span class="built_in">Unit</span> = &#123; emit -&gt; <span class="comment">// 1</span></span><br><span class="line">        emit(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    f &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">    f &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加的参数看起来有点乱🤔，稍微修改一下，抽出来吧：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> FlowCollector &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">emit</span><span class="params">(value: <span class="type">String</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> f: (FlowCollector) -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">        it.emit(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">        it.emit(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        it.emit(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    f &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">    f &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好像能把<code>it</code>的调用逻辑去掉，这样更简洁：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> FlowCollector &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">emit</span><span class="params">(value: <span class="type">String</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> f: FlowCollector.() -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">        emit(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    f &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">    f &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用lambda表达式不是很方便。如果把它抽成接口🤔</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> FlowCollector &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">emit</span><span class="params">(value: <span class="type">String</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Flow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">collect</span><span class="params">(collector: <span class="type">FlowCollector</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> builder: FlowCollector.() -&gt; <span class="built_in">Unit</span> = &#123;</span><br><span class="line">        emit(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> flow: Flow = <span class="keyword">object</span> : Flow &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">collect</span><span class="params">(collector: <span class="type">FlowCollector</span>)</span></span> &#123;</span><br><span class="line">            collector.builder()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    flow.collect &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">    flow.collect &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抽成可以重复调用的构建器：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> FlowCollector &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">emit</span><span class="params">(value: <span class="type">String</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Flow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">collect</span><span class="params">(collector: <span class="type">FlowCollector</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">flow</span><span class="params">(builder: <span class="type">FlowCollector</span>.() -&gt; <span class="type">Unit</span>)</span></span> = <span class="keyword">object</span> : Flow &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">collect</span><span class="params">(collector: <span class="type">FlowCollector</span>)</span></span> &#123;</span><br><span class="line">        collector.builder()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> f: Flow = flow &#123;</span><br><span class="line">        emit(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    f.collect &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">    f.collect &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>泛型化参数更通用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.*</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> FlowCollector<span class="type">&lt;T&gt;</span> &#123;</span></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">emit</span><span class="params">(value: <span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Flow</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">collect</span><span class="params">(collector: <span class="type">FlowCollector</span>&lt;<span class="type">T</span>&gt;)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">flow</span><span class="params">(builder: <span class="type">suspend</span> <span class="type">FlowCollector</span>&lt;<span class="type">T</span>&gt;.() -&gt; <span class="type">Unit</span>)</span></span> = <span class="keyword">object</span> : Flow&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">collect</span><span class="params">(collector: <span class="type">FlowCollector</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">        collector.builder()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> f: Flow&lt;String&gt; = flow &#123;</span><br><span class="line">        emit(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        emit(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    f.collect &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">    f.collect &#123; print(it) &#125; <span class="comment">// ABC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://kt.academy/article/how-flow-works">参考</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/android-jetpack-compose-state-management.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/android-jetpack-compose-state-management.html" class="post-title-link" itemprop="url">Jetpack Compose State Management</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-18 14:34:49" itemprop="dateCreated datePublished" datetime="2022-05-18T14:34:49+08:00">2022-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>–</p>
<center>
    <img src="../images/ui-equals-function-of-state.png" width="100%"/>
</center>

<h4 id="一、什么是状态"><a href="#一、什么是状态" class="headerlink" title="一、什么是状态"></a>一、什么是状态</h4><blockquote>
<p>状态是一些被View、Widget订阅或观察的对象，它包含数据。任何状态（数据）的变化都会通知给观察它的View、Widget。</p>
</blockquote>
<ul>
<li>网络断开时展示的Toast</li>
<li>发布的博客及其评论</li>
<li>点击按钮时的水波纹动画</li>
</ul>
<h4 id="二、Compose中的状态"><a href="#二、Compose中的状态" class="headerlink" title="二、Compose中的状态"></a>二、Compose中的状态</h4><h5 id="2-1-记住状态"><a href="#2-1-记住状态" class="headerlink" title="2.1 记住状态"></a>2.1 记住状态</h5><p>Composable函数可以使用<code>remember</code>在初始化时存储一个对象到内存中。每次recomposition时这个对象都会被返回。</p>
<h5 id="2-2-可观察状态"><a href="#2-2-可观察状态" class="headerlink" title="2.2 可观察状态"></a>2.2 可观察状态</h5><p><code>mutableStateOf</code>函数可以创建一个可观察的可变数据，此数据的变化将触发recomposition</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">MySwitch</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">// I have a State in Compose&#x27;s MutableState</span></span><br><span class="line">   <span class="keyword">val</span> checked = remember &#123; mutableStateOf(<span class="literal">false</span>) &#125;</span><br><span class="line">   Switch(</span><br><span class="line">       <span class="comment">// Observe the State by accessing the value property</span></span><br><span class="line">       checked = checked.value,</span><br><span class="line">       onCheckedChange = &#123;</span><br><span class="line">           checked.value = it</span><br><span class="line">       &#125;</span><br><span class="line">   )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-其他状态类型"><a href="#2-3-其他状态类型" class="headerlink" title="2.3 其他状态类型"></a>2.3 其他状态类型</h5><p>除了使用<code>MutableState&lt;T&gt;</code>持有状态外，你还可以使用以下这些可观察数据类型来维护状态。</p>
<ul>
<li>LiveData</li>
<li>Flow</li>
<li>RxJava2</li>
</ul>
<p>但是，在使用时需要将其转成<code>State&lt;T&gt;</code>类型</p>
<ul>
<li><code>LiveData&lt;T&gt;.observeAsState()</code></li>
<li><code>Flow&lt;T&gt;.collectAsState()</code></li>
</ul>
<h5 id="2-4-stateless"><a href="#2-4-stateless" class="headerlink" title="2.4 stateless"></a>2.4 stateless</h5><p>在Composable函数中保存状态将降低它的可复用性，通过将状态向外抽离来增加其复用性。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">HelloScreen</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name <span class="keyword">by</span> rememberSaveable &#123; mutableStateOf(<span class="string">&quot;&quot;</span>) &#125;</span><br><span class="line"></span><br><span class="line">    HelloContent(name = name, onNameChange = &#123; name = it &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">HelloContent</span><span class="params">(name: <span class="type">String</span>, onNameChange: (<span class="type">String</span>) -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    Column(modifier = Modifier.padding(<span class="number">16.</span>dp)) &#123;</span><br><span class="line">        Text(</span><br><span class="line">            text = <span class="string">&quot;Hello, <span class="variable">$name</span>&quot;</span>,</span><br><span class="line">            modifier = Modifier.padding(bottom = <span class="number">8.</span>dp),</span><br><span class="line">            style = MaterialTheme.typography.h5</span><br><span class="line">        )</span><br><span class="line">        OutlinedTextField(</span><br><span class="line">            value = name,</span><br><span class="line">            onValueChange = onNameChange,</span><br><span class="line">            label = &#123; Text(<span class="string">&quot;Name&quot;</span>) &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-5-状态恢复"><a href="#2-5-状态恢复" class="headerlink" title="2.5 状态恢复"></a>2.5 状态恢复</h5><p>当Activity重建时，想要保留状态，并在重建后恢复状态，可以使用<code>rememberSaveable</code>将状态保存到Bundle中。</p>
<ul>
<li>Parcelize</li>
<li>MapSaver</li>
<li>ListSaver</li>
</ul>
<h4 id="三、参考"><a href="#三、参考" class="headerlink" title="三、参考"></a>三、参考</h4><p><a target="_blank" rel="noopener" href="https://developer.android.com/jetpack/compose/state#state-in-composables">State and Jetpack Compose</a><br><a target="_blank" rel="noopener" href="https://medium.com/@takahirom/jetpack-compose-state-guideline-494d467b6e76">Jetpack Compose State Guideline</a><br><a target="_blank" rel="noopener" href="https://levelup.gitconnected.com/managing-state-in-android-f4d042646521">Managing State in Android</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangduwei.top/android-jetpack-compose-sideeffect.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangduwei">
      <meta itemprop="description" content="耐心和坚持">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="蓝色的笔记本">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/android-jetpack-compose-sideeffect.html" class="post-title-link" itemprop="url">Jetpack Compose Side Effects</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-17 16:11:13" itemprop="dateCreated datePublished" datetime="2022-05-17T16:11:13+08:00">2022-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-29 19:50:54" itemprop="dateModified" datetime="2024-04-29T19:50:54+08:00">2024-04-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="一、什么是Side-Effect"><a href="#一、什么是Side-Effect" class="headerlink" title="一、什么是Side-Effect"></a>一、什么是Side-Effect</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Side_effect_(computer_science)">wiki</a>:在计算机科学中，当函数、表达式、操作会修改它作用域之外的状态变量值时，我们就说它具有副作用。也就是说除返回值之外其他的对外修改都叫副作用。<br>常见的例子包括：修改非本地变量、修改参数传进来的可变引用、执行I/O等。</p>
</blockquote>
<h4 id="二、Compose中的Side-Effect"><a href="#二、Compose中的Side-Effect" class="headerlink" title="二、Compose中的Side-Effect"></a>二、Compose中的Side-Effect</h4><p>因为Jetpack Compose是由一系列的<code>@Composable</code>函数组成的，<code>@Composable</code>函数在执行时可能会被跳过（出于优化的角度）或执行多次（recomposition）。<br>那对于函数内部的网络请求、对外部状态的修改怎么办？有可能执行多次？有可能不执行？这就产生了某种不可预期的错误状态，或者泄露。<br>为了解决此类问题，Compose提供了相应的API，这些API主要聚焦于对这些副作用的生命周期进行管理。</p>
<p>这些API可以分成两大类：</p>
<ul>
<li>SuspendedEffect<ul>
<li>rememberCoroutineScope</li>
<li>launchedEffect</li>
</ul>
</li>
<li>Non-Suspended Side Effects<ul>
<li>DisposableEffect</li>
<li>SideEffect</li>
</ul>
</li>
</ul>
<h4 id="三、SuspendedEffect"><a href="#三、SuspendedEffect" class="headerlink" title="三、SuspendedEffect"></a>三、SuspendedEffect</h4><h5 id="3-1-LaunchedEffect"><a href="#3-1-LaunchedEffect" class="headerlink" title="3.1 LaunchedEffect"></a>3.1 LaunchedEffect</h5><p>在首次composition的时候被调用。recomposition时不会再次调用。可以通过改变Key让其重新调用。<br>它是一个协程作用域，我们可以执行一些挂起函数，当composable函数退出时，协程会被取消。</p>
<p>下面的例子中，启动即执行循环逻辑，每秒修改一次状态值并触发recomposition，但recomposition并不影响LaunchedEffect内的逻辑。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">LaunchedEffect</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> timer <span class="keyword">by</span> remember &#123; mutableStateOf(<span class="number">0</span>) &#125;</span><br><span class="line">    Box(modifier = Modifier.fillMaxSize(), </span><br><span class="line">        contentAlignment = Alignment.Center) &#123;</span><br><span class="line">        Text(<span class="string">&quot;Time <span class="variable">$timer</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LaunchedEffect(key1 = <span class="built_in">Unit</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            delay(<span class="number">1000</span>)</span><br><span class="line">            timer++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-RememberCoroutineScope"><a href="#3-2-RememberCoroutineScope" class="headerlink" title="3.2 RememberCoroutineScope"></a>3.2 RememberCoroutineScope</h5><p><code>LaunchedEffect</code>的启动和取消跟随Composable函数的生命周期。如果想自己控制生命周期可以使用<code>RememberCoroutineScope</code></p>
<p>下面的例子中，协程的控制权转移到我们自己手中：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">JustRememberCoroutineScope</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> scope = rememberCoroutineScope()</span><br><span class="line">    <span class="keyword">var</span> timer <span class="keyword">by</span> remember &#123; mutableStateOf(<span class="number">0</span>) &#125;</span><br><span class="line">    <span class="keyword">var</span> timerStartStop <span class="keyword">by</span> remember &#123; mutableStateOf(<span class="literal">false</span>) &#125;</span><br><span class="line">    <span class="keyword">var</span> job: Job? <span class="keyword">by</span> remember &#123; mutableStateOf(<span class="literal">null</span>) &#125;</span><br><span class="line"></span><br><span class="line">    Box(modifier = Modifier.fillMaxSize(),</span><br><span class="line">        contentAlignment = Alignment.Center) &#123;</span><br><span class="line">        Column(horizontalAlignment = Alignment.CenterHorizontally) &#123;</span><br><span class="line">            Text(<span class="string">&quot;Time <span class="variable">$timer</span>&quot;</span>)</span><br><span class="line">            Button(onClick = &#123;</span><br><span class="line">                timerStartStop = !timerStartStop</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (timerStartStop) &#123;</span><br><span class="line">                    job?.cancel()</span><br><span class="line">                    job = scope.launch &#123;</span><br><span class="line">                        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                            delay(<span class="number">1000</span>)</span><br><span class="line">                            timer++</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    job?.cancel()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;) &#123;</span><br><span class="line">                Text(<span class="keyword">if</span> (timerStartStop) <span class="string">&quot;Stop&quot;</span> <span class="keyword">else</span> <span class="string">&quot;Start&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="四、Non-Suspended-Side-Effects"><a href="#四、Non-Suspended-Side-Effects" class="headerlink" title="四、Non-Suspended Side Effects"></a>四、Non-Suspended Side Effects</h4><h5 id="4-1-DisposableEffect"><a href="#4-1-DisposableEffect" class="headerlink" title="4.1 DisposableEffect"></a>4.1 DisposableEffect</h5><p>与<code>LaunchedEffect</code>一样，立即启动，通过修改key可以再次启动。它提供了一个销毁时的回调，当再次启动时，前一个的<code>onDispose</code>方法会被回调。</p>
<p>下面的例子每次点击按钮改变状态进行recompose，同时会改变<code>DisposableEffect</code>的key，销毁上一个Effect并收到回调。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">JustDisposableEffect</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> timerStartStop <span class="keyword">by</span> remember &#123; mutableStateOf(<span class="literal">false</span>) &#125;</span><br><span class="line">    Box(modifier = Modifier.fillMaxSize(),</span><br><span class="line">        contentAlignment = Alignment.Center) &#123;</span><br><span class="line">        Column(horizontalAlignment = Alignment.CenterHorizontally) &#123;</span><br><span class="line">            Button(onClick = &#123;</span><br><span class="line">                timerStartStop = !timerStartStop</span><br><span class="line">            &#125;) &#123;</span><br><span class="line">                Text(<span class="keyword">if</span> (timerStartStop) <span class="string">&quot;Stop&quot;</span> <span class="keyword">else</span> <span class="string">&quot;Start&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> context = LocalContext.current</span><br><span class="line"></span><br><span class="line">    DisposableEffect(key1 = timerStartStop) &#123;</span><br><span class="line">        <span class="keyword">val</span> x = (<span class="number">1.</span><span class="number">.10</span>).random()</span><br><span class="line">        Toast.makeText(context, <span class="string">&quot;Start <span class="variable">$x</span>&quot;</span>, LENGTH_SHORT).show()</span><br><span class="line"></span><br><span class="line">        onDispose &#123;</span><br><span class="line">            Toast.makeText(context, <span class="string">&quot;Stop <span class="variable">$x</span>&quot;</span>, LENGTH_SHORT).show()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-2-SideEffect"><a href="#4-2-SideEffect" class="headerlink" title="4.2 SideEffect"></a>4.2 SideEffect</h5><p>使用场景：</p>
<ul>
<li>每次composition / recomposition成功后被调用</li>
<li>用于对外部状态的更新</li>
<li>无需做清理回收操作时</li>
</ul>
<p>例1：对外部状态的更新</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">MyScreen</span><span class="params">(drawerTouchHandler: <span class="type">TouchHandler</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> drawerState = rememberDrawerState(DrawerValue.Closed)</span><br><span class="line"></span><br><span class="line">  SideEffect &#123;</span><br><span class="line">    drawerTouchHandler.enabled = drawerState.isOpen</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例2：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">MyComposable</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SideEffect &#123; <span class="comment">//this will handle the side effect that may occur</span></span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    Button(onClick = &#123;&#125;)&#123;</span><br><span class="line">        Text(text = <span class="string">&quot;Click&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="五、参考"><a href="#五、参考" class="headerlink" title="五、参考"></a>五、参考</h4><p><a target="_blank" rel="noopener" href="https://jorgecastillo.dev/jetpack-compose-effect-handlers">Jetpack Compose Effect Handlers</a><br><a target="_blank" rel="noopener" href="https://www.section.io/engineering-education/side-effects-and-effects-handling-in-jetpack-compose/">SideEffects and Effects Handling in Jetpack Compose</a><br><a target="_blank" rel="noopener" href="https://medium.com/mobile-app-development-publication/jetpack-compose-side-effects-made-easy-a4867f876928">Jetpack Compose Side Effects Made Easy</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/archives/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/archives/">1</a><span class="page-number current">2</span><a class="page-number" href="/archives/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/archives/page/5/">5</a><a class="extend next" rel="next" href="/archives/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wangduwei</p>
  <div class="site-description" itemprop="description">耐心和坚持</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangduwei</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">129k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">1:58</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  



  <script>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : ,
      el    : 'wpac-rating',
      color : 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>

  
<script src="/js/local-search.js"></script>













  

  


  <!-- 页面点击小红心 -->
  
        <script type="text/javascript" src="/js/love.js"></script>
  
</body>
</html>
